//
//  ContentView.swift
//  Heartbeat
//
//  Created by Liam Arbuckle on 8/1/2026.
//

import SwiftUI
import SwiftData

struct ContentView: View {
    @Environment(\.modelContext) private var modelContext
    @Query private var datePeople: [DatePerson]
    @Environment(\.colorScheme) private var colorScheme
    
    @State private var showingOnboarding = false
    @State private var showingArchive = false
    
    // Computed property to find the current person (most recent date)
    private var currentPerson: DatePerson? {
        return datePeople.max { person1, person2 in
            let person1LastDate = person1.previousDates.map(\.date).max() ?? person1.meetingDate
            let person2LastDate = person2.previousDates.map(\.date).max() ?? person2.meetingDate
            return person1LastDate < person2LastDate
        }
    }
    
    // Computed property to get archived people (everyone except current)
    private var archivedPeople: [DatePerson] {
        guard let current = currentPerson else { return datePeople }
        return datePeople.filter { $0.id != current.id }
    }
    
    var body: some View {
        NavigationView {
            ZStack {
                AppStyle.Colors.background(for: colorScheme)
                    .ignoresSafeArea()
                
                if datePeople.isEmpty {
                    // Empty state
                    EmptyStateView {
                        showingOnboarding = true
                    }
                } else if let current = currentPerson {
                    // Show current person's profile directly
                    PersonDetailView(person: current)
                } else {
                    // Fallback (shouldn't happen)
                    Text("NO DATA")
                        .font(AppStyle.Fonts.body)
                        .foregroundColor(AppStyle.Colors.textPrimary(for: colorScheme))
                }
            }
            .navigationTitle("HEARTBEAT")
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    if !datePeople.isEmpty && !archivedPeople.isEmpty {
                        Button("ARCHIVE") {
                            showingArchive = true
                        }
                        .foregroundColor(AppStyle.Colors.accent)
                    }
                }
                
                // Only show the "add new person" button when there are no people (empty state)
                // When someone is already being seen, this button is hidden
                if datePeople.isEmpty {
                    ToolbarItem(placement: .navigationBarTrailing) {
                        Button {
                            showingOnboarding = true
                        } label: {
                            Image(systemName: "plus")
                                .foregroundColor(AppStyle.Colors.accent)
                        }
                    }
                }
            }
        }
        .sheet(isPresented: $showingOnboarding) {
            OnboardingFlow()
        }
        .sheet(isPresented: $showingArchive) {
            ArchiveView(archivedPeople: archivedPeople)
        }
    }
}
    
    var body: some View {
        VStack(spacing: 20) {
            // Large photo
            Group {
                if let profileImage = person.profileImage {
                    profileImage
                        .resizable()
                        .aspectRatio(contentMode: .fill)
                } else {
                    Rectangle()
                        .fill(AppStyle.Colors.textSecondary(for: colorScheme).opacity(0.3))
                        .overlay {
                            Image(systemName: "person.fill")
                                .font(.system(size: 60, weight: .black))
                                .foregroundColor(AppStyle.Colors.textSecondary(for: colorScheme))
                        }
                }
            }
            .frame(width: 150, height: 150)
            .overlay {
                Rectangle()
                    .stroke(AppStyle.Colors.borderColor, lineWidth: AppStyle.Layout.borderWidth)
            }
            .shadow(
                color: AppStyle.Colors.shadowColor,
                radius: 0,
                x: AppStyle.Layout.shadowOffset.width,
                y: AppStyle.Layout.shadowOffset.height
            )
            
            VStack(spacing: 12) {
                Text(person.name)
                    .font(AppStyle.Fonts.heading)
                    .foregroundColor(AppStyle.Colors.textPrimary(for: colorScheme))
                
                Text(lastDateText)
                    .font(AppStyle.Fonts.body)
                    .foregroundColor(AppStyle.Colors.textSecondary(for: colorScheme))
                
                if !person.previousDates.isEmpty {
                    Rectangle()
                        .fill(AppStyle.Colors.accent)
                        .frame(width: 120, height: 40)
                        .overlay {
                            Text("\(person.previousDates.count) DATES")
                                .font(AppStyle.Fonts.caption)
                                .foregroundColor(.white)
                        }
                        .overlay {
                            Rectangle()
                                .stroke(AppStyle.Colors.borderColor, lineWidth: 2)
                        }
                        .shadow(
                            color: AppStyle.Colors.shadowColor,
                            radius: 0,
                            x: 3,
                            y: 3
                        )
                }
            }
        }
        .padding(24)
        }
    }


struct ArchiveView: View {
    let archivedPeople: [DatePerson]
    @Environment(\.dismiss) private var dismiss
    @Environment(\.colorScheme) private var colorScheme
    
    var body: some View {
        NavigationView {
            ZStack {
                AppStyle.Colors.background(for: colorScheme)
                    .ignoresSafeArea()
                
                ScrollView {
                    LazyVStack(spacing: 16) {
                        ForEach(archivedPeople.sorted(by: { person1, person2 in
                            let date1 = person1.previousDates.map(\.date).max() ?? person1.meetingDate
                            let date2 = person2.previousDates.map(\.date).max() ?? person2.meetingDate
                            return date1 > date2
                        })) { person in
                            NavigationLink {
                                PersonDetailView(person: person)
                            } label: {
                                PersonRowView(person: person)
                                    .foregroundColor(AppStyle.Colors.textPrimary(for: colorScheme))
                            }
                            .buttonStyle(PlainButtonStyle())
                        }
                    }
                    .padding(.horizontal)
                    .padding(.top)
                }
            }
            .navigationTitle("ARCHIVE")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("DONE") {
                        dismiss()
                    }
                    .foregroundColor(AppStyle.Colors.accent)
                }
            }
        }
    }
}

struct PersonRowView: View {
    let person: DatePerson
    @Environment(\.colorScheme) private var colorScheme
    
    var body: some View {
        HStack(spacing: 16) {
            // Profile photo or placeholder
            Group {
                if let profileImage = person.profileImage {
                    profileImage
                        .resizable()
                        .aspectRatio(contentMode: .fill)
                } else {
                    Rectangle()
                        .fill(AppStyle.Colors.textSecondary(for: colorScheme).opacity(0.3))
                        .overlay {
                            Image(systemName: "person.fill")
                                .font(.system(size: 24, weight: .black))
                                .foregroundColor(AppStyle.Colors.textSecondary(for: colorScheme))
                        }
                }
            }
            .frame(width: 60, height: 60)
            .overlay {
                Rectangle()
                    .stroke(AppStyle.Colors.borderColor, lineWidth: AppStyle.Layout.borderWidth)
            }
            .shadow(
                color: AppStyle.Colors.shadowColor,
                radius: 0,
                x: 3,
                y: 3
            )
            
            VStack(alignment: .leading, spacing: 8) {
                Text(person.name)
                    .font(AppStyle.Fonts.body)
                    .foregroundColor(AppStyle.Colors.textPrimary(for: colorScheme))
                
                Text("FIRST MET: \(person.meetingDate.formatted(date: .abbreviated, time: .omitted).uppercased())")
                    .font(AppStyle.Fonts.caption)
                    .foregroundColor(AppStyle.Colors.textSecondary(for: colorScheme))
            }
            
            Spacer()
            
            if !person.previousDates.isEmpty {
                Rectangle()
                    .fill(AppStyle.Colors.accent)
                    .frame(width: 80, height: 40)
                    .overlay {
                        Text("\(person.previousDates.count) DATES")
                            .font(AppStyle.Fonts.caption)
                            .foregroundColor(.white)
                    }
                    .overlay {
                        Rectangle()
                            .stroke(AppStyle.Colors.borderColor, lineWidth: 2)
                    }
                    .shadow(
                        color: AppStyle.Colors.shadowColor,
                        radius: 0,
                        x: 2,
                        y: 2
                    )
            }
        }
        .padding(.vertical, 12)
        .padding(.horizontal, 16)
        .neobrutalistCard()
    }
}

struct PersonDetailView: View {
    let person: DatePerson
    @Environment(\.colorScheme) private var colorScheme
    @Environment(\.modelContext) private var modelContext
    @State private var showingAddDate = false
    
    var body: some View {
        ScrollView {
            VStack(alignment: .leading, spacing: 32) {
                // Header with photo and basic info
                VStack(spacing: 24) {
                    Group {
                        if let profileImage = person.profileImage {
                            profileImage
                                .resizable()
                                .aspectRatio(contentMode: .fill)
                        } else {
                            Rectangle()
                                .fill(AppStyle.Colors.textSecondary(for: colorScheme).opacity(0.3))
                                .overlay {
                                    Image(systemName: "person.fill")
                                        .font(.system(size: 48, weight: .black))
                                        .foregroundColor(AppStyle.Colors.textSecondary(for: colorScheme))
                                }
                        }
                    }
                    .frame(width: 150, height: 150)
                    .overlay {
                        Rectangle()
                            .stroke(AppStyle.Colors.borderColor, lineWidth: AppStyle.Layout.borderWidth)
                    }
                    .shadow(
                        color: AppStyle.Colors.shadowColor,
                        radius: 0,
                        x: AppStyle.Layout.shadowOffset.width,
                        y: AppStyle.Layout.shadowOffset.height
                    )
                    
                    Text(person.name)
                        .font(AppStyle.Fonts.heading)
                        .foregroundColor(AppStyle.Colors.textPrimary(for: colorScheme))
                    
                    Text("FIRST MET: \(person.meetingDate.formatted(date: .complete, time: .omitted).uppercased())")
                        .font(AppStyle.Fonts.body)
                        .foregroundColor(AppStyle.Colors.textSecondary(for: colorScheme))
                        .multilineTextAlignment(.center)
                    
                    // Phone number and iMessage button
                    if !person.phoneNumber.isEmpty {
                        VStack(spacing: 12) {
                            Text("PHONE: \(person.phoneNumber)")
                                .font(AppStyle.Fonts.body)
                                .foregroundColor(AppStyle.Colors.textSecondary(for: colorScheme))
                            
                            Button("MESSAGE") {
                                openIMessage(phoneNumber: person.phoneNumber)
                            }
                            .neobrutalistButton(
                                backgroundColor: Color.green,
                                foregroundColor: .white,
                                isPressed: false
                            )
                        }
                        .neobrutalistCard()
                    }
                }
                .frame(maxWidth: .infinity)
                .padding(.vertical)
                
                // Previous dates section
                if !person.previousDates.isEmpty {
                    VStack(alignment: .leading, spacing: 20) {
                        Text("PREVIOUS DATES")
                            .font(AppStyle.Fonts.heading)
                            .foregroundColor(AppStyle.Colors.textPrimary(for: colorScheme))
                        
                        ForEach(person.previousDates.sorted(by: { $0.date > $1.date }), id: \.location) { previousDate in
                            VStack(alignment: .leading, spacing: 12) {
                                Button(action: {
                                    openInMaps(location: previousDate.location, latitude: previousDate.latitude, longitude: previousDate.longitude)
                                }) {
                                    HStack {
                                        Text(previousDate.location.uppercased())
                                            .font(AppStyle.Fonts.body)
                                            .foregroundColor(AppStyle.Colors.textPrimary(for: colorScheme))
                                        Spacer()
                                        Image(systemName: "map.fill")
                                            .font(.system(size: 16, weight: .bold))
                                            .foregroundColor(AppStyle.Colors.accent)
                                    }
                                }
                                .buttonStyle(PlainButtonStyle())
                                
                                HStack {
                                    Text(previousDate.date.formatted(date: .abbreviated, time: .omitted).uppercased())
                                        .font(AppStyle.Fonts.caption)
                                        .foregroundColor(AppStyle.Colors.textSecondary(for: colorScheme))
                                    
                                    Text("â€¢")
                                        .foregroundColor(AppStyle.Colors.textSecondary(for: colorScheme))
                                    
                                    Text(previousDate.time.formatted(date: .omitted, time: .shortened))
                                        .font(AppStyle.Fonts.caption)
                                        .foregroundColor(AppStyle.Colors.textSecondary(for: colorScheme))
                                }
                            }
                            .neobrutalistCard()
                        }
                    }
                }
                
                Spacer(minLength: 100)
            }
            .padding(.horizontal)
        }
        .background(AppStyle.Colors.background(for: colorScheme))
        .navigationBarTitleDisplayMode(.inline)
        .toolbar {
            ToolbarItem(placement: .navigationBarTrailing) {
                Button {
                    showingAddDate = true
                } label: {
                    Image(systemName: "plus")
                        .foregroundColor(AppStyle.Colors.accent)
                }
            }
        }
        .sheet(isPresented: $showingAddDate) {
            AddDateView(person: person)
        }
    }
    
    private func openIMessage(phoneNumber: String) {
        let cleanedPhoneNumber = phoneNumber.components(separatedBy: CharacterSet.decimalDigits.inverted).joined()
        if let url = URL(string: "sms:\(cleanedPhoneNumber)") {
            UIApplication.shared.open(url)
        }
    }
    
    private func openInMaps(location: String, latitude: Double?, longitude: Double?) {
        if let lat = latitude, let lon = longitude {
            let url = URL(string: "maps://?q=\(lat),\(lon)")
            if let url = url, UIApplication.shared.canOpenURL(url) {
                UIApplication.shared.open(url)
            }
        } else {
            let encodedLocation = location.addingPercentEncoding(withAllowedCharacters: .urlQueryAllowed) ?? ""
            if let url = URL(string: "maps://?q=\(encodedLocation)") {
                UIApplication.shared.open(url)
            }
        }
    }
}

#Preview {
    ContentView()
        .modelContainer(for: DatePerson.self, inMemory: true)
}

struct AddDateView: View {
    let person: DatePerson
    @Environment(\.dismiss) private var dismiss
    @Environment(\.colorScheme) private var colorScheme
    @Environment(\.modelContext) private var modelContext
    
    @State private var location = ""
    @State private var latitude: Double?
    @State private var longitude: Double?
    @State private var date = Date()
    @State private var time = Date()
    @State private var notes = ""
    @State private var showingLocationSearch = false
    
    var body: some View {
        NavigationView {
            ZStack {
                AppStyle.Colors.background(for: colorScheme)
                    .ignoresSafeArea()
                
                VStack(spacing: 24) {
                    Text("ADD DATE WITH \(person.name.uppercased())")
                        .font(AppStyle.Fonts.heading)
                        .foregroundColor(AppStyle.Colors.textPrimary(for: colorScheme))
                        .multilineTextAlignment(.center)
                    
                    VStack(spacing: 20) {
                        // Location search
                        Button(action: {
                            showingLocationSearch = true
                        }) {
                            HStack {
                                Text(location.isEmpty ? "TAP TO SEARCH LOCATION" : location.uppercased())
                                    .font(AppStyle.Fonts.body)
                                    .foregroundColor(location.isEmpty ? AppStyle.Colors.textSecondary(for: colorScheme) : AppStyle.Colors.textPrimary(for: colorScheme))
                                Spacer()
                                Image(systemName: "magnifyingglass")
                                    .font(.system(size: 16, weight: .bold))
                                    .foregroundColor(AppStyle.Colors.accent)
                            }
                            .padding(20)
                            .background(AppStyle.Colors.surface(for: colorScheme))
                            .overlay {
                                Rectangle()
                                    .stroke(AppStyle.Colors.borderColor, lineWidth: AppStyle.Layout.borderWidth)
                            }
                            .shadow(
                                color: AppStyle.Colors.shadowColor,
                                radius: 0,
                                x: 3,
                                y: 3
                            )
                        }
                        .buttonStyle(PlainButtonStyle())
                        
                        // Date and time
                        VStack(spacing: 16) {
                            Text("DATE & TIME")
                                .font(AppStyle.Fonts.body)
                                .foregroundColor(AppStyle.Colors.textSecondary(for: colorScheme))
                            
                            HStack(spacing: 12) {
                                DatePicker("Date", selection: $date, displayedComponents: [.date])
                                    .labelsHidden()
                                    .accentColor(AppStyle.Colors.accent)
                                
                                DatePicker("Time", selection: $time, displayedComponents: [.hourAndMinute])
                                    .labelsHidden()
                                    .accentColor(AppStyle.Colors.accent)
                            }
                        }
                        .neobrutalistCard()
                        
                        // Notes (optional)
                        VStack(spacing: 16) {
                            Text("NOTES (OPTIONAL)")
                                .font(AppStyle.Fonts.body)
                                .foregroundColor(AppStyle.Colors.textSecondary(for: colorScheme))
                            
                            TextField("HOW WAS THE DATE?", text: $notes, axis: .vertical)
                                .textFieldStyle(CustomTextFieldStyle())
                                .lineLimit(3...6)
                        }
                    }
                    
                    Spacer()
                    
                    // Action buttons
                    HStack(spacing: 16) {
                        Button("CANCEL") {
                            dismiss()
                        }
                        .buttonStyle(SecondaryButtonStyle())
                        
                        Spacer()
                        
                        Button("SAVE DATE") {
                            saveDate()
                        }
                        .buttonStyle(PrimaryButtonStyle())
                        .disabled(location.isEmpty)
                    }
                }
                .padding(.horizontal, 24)
                .padding(.vertical, 32)
            }
            .navigationBarHidden(true)
        }
        .sheet(isPresented: $showingLocationSearch) {
            LocationSearchView(
                selectedLocation: $location,
                latitude: $latitude,
                longitude: $longitude
            )
        }
    }
    
    private func saveDate() {
        let newDate = PreviousDate(
            location: location,
            latitude: latitude,
            longitude: longitude,
            date: date,
            time: time,
            notes: notes
        )
        
        person.previousDates.append(newDate)
        
        do {
            try modelContext.save()
        } catch {
            print("Error saving date: \(error)")
        }
        
        dismiss()
    }
}

// Custom button styles - NEOBRUTALIST
struct PrimaryButtonStyle: ButtonStyle {
    @Environment(\.colorScheme) private var colorScheme
    
    func makeBody(configuration: Configuration) -> some View {
        configuration.label
            .neobrutalistButton(
                backgroundColor: AppStyle.Colors.accent,
                foregroundColor: .white,
                isPressed: configuration.isPressed
            )
    }
}

struct CustomTextFieldStyle: TextFieldStyle {
    @Environment(\.colorScheme) private var colorScheme
    
    func _body(configuration: TextField<Self._Label>) -> some View {
        configuration
            .font(AppStyle.Fonts.body)
            .padding(20)
            .background(AppStyle.Colors.surface(for: colorScheme))
            .overlay {
                Rectangle()
                    .stroke(AppStyle.Colors.borderColor, lineWidth: AppStyle.Layout.borderWidth)
            }
            .shadow(
                color: AppStyle.Colors.shadowColor,
                radius: 0,
                x: 3,
                y: 3
            )
    }
}

struct SecondaryButtonStyle: ButtonStyle {
    @Environment(\.colorScheme) private var colorScheme
    
    func makeBody(configuration: Configuration) -> some View {
        configuration.label
            .neobrutalistButton(
                backgroundColor: AppStyle.Colors.surface(for: colorScheme),
                foregroundColor: AppStyle.Colors.textPrimary(for: colorScheme),
                isPressed: configuration.isPressed
            )
    }
}
